pipeline {
    agent any

    environment {
        APP_ENV = "local"
        APP_DEBUG = "true"
        APP_KEY = ""
        DB_CONNECTION = "mysql"
        DB_HOST = "127.0.0.1"
        DB_PORT = "3306"
        DB_DATABASE = "bookshare"
       DB_USERNAME="laravel"
DB_PASSWORD="secret123"

        PHP_PATH = "/usr/bin/php"
        COMPOSER_PATH = "/usr/local/bin/composer"
        NODE_PATH = "/usr/bin/npm"
    }

    stages {

        stage('Checkout') {
            steps {
                echo 'ğŸ“¦ Checkout du code depuis GitHub...'
                git branch: 'main', url: 'https://github.com/Abdessalem-Chaouch/Bookshare.git'
            }
        }

        stage('Install Dependencies') {
            steps {
                echo 'ğŸ“¦ Installation des dÃ©pendances Laravel...'
                sh '${COMPOSER_PATH} install --no-interaction --prefer-dist --no-progress'
                echo 'ğŸ“¦ Installation des dÃ©pendances NPM...'
                sh '${NODE_PATH} install'
            }
        }

        stage('Setup Environment') {
            steps {
                echo 'âš™ï¸ Configuration du fichier .env et clÃ© Laravel...'
                sh '''
                    if [ ! -f .env ]; then
                        cp .env.example .env
                    fi
                    ${PHP_PATH} artisan key:generate
                '''
            }
        }

        stage('Ensure MySQL is running') {
            steps {
                echo 'ğŸ›¡ï¸ VÃ©rification de MySQL...'
                sh '''
                    sudo service mysql start || true
                    until mysqladmin ping -h${DB_HOST} -P${DB_PORT} --silent; do
                        echo "Attente du dÃ©marrage de MySQL..."
                        sleep 2
                    done
                    echo "MySQL est opÃ©rationnel"
                '''
            }
        }

        stage('Create Database if not exists') {
            steps {
                echo 'ğŸ—„ï¸ CrÃ©ation de la base de donnÃ©es si nÃ©cessaire...'
                sh '''
                    mysql -h${DB_HOST} -P${DB_PORT} -u${DB_USERNAME} -p${DB_PASSWORD} -e "CREATE DATABASE IF NOT EXISTS ${DB_DATABASE} CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;"
                '''
            }
        }

        stage('Run Migrations & Storage') {
            steps {
                echo 'ğŸ—„ï¸ Migration de la base de donnÃ©es et configuration du stockage...'
                sh '''
                    ${PHP_PATH} artisan migrate --force
                    ${PHP_PATH} artisan storage:link || true
                '''
            }
        }

        stage('Build Vite') {
            steps {
                echo 'âš™ï¸ Compilation du projet Laravel avec Vite...'
                sh '${NODE_PATH} run build'
            }
        }

        stage('Run Dev Server') {
            steps {
                echo 'ğŸš€ Lancement du serveur de dÃ©veloppement...'
                sh 'nohup ${NODE_PATH} run dev >/dev/null 2>&1 &'
            }
        }
    }

    post {
        success {
            echo 'âœ… Pipeline exÃ©cutÃ©e avec succÃ¨s ! Application Laravel opÃ©rationnelle ğŸ‰'
        }
        failure {
            echo 'âŒ Ã‰chec de la pipeline ! VÃ©rifie les logs Jenkins pour plus de dÃ©tails.'
        }
    }
}
